# Makefile para AUM Scraper Backend

.PHONY: help build up down logs test clean migrate init

# VariÃ¡veis
DOCKER_COMPOSE = docker-compose
BACKEND_SERVICE = backend

help: ## Mostra esta ajuda
	@echo "Comandos disponÃ­veis:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

build: ## ConstrÃ³i as imagens Docker
	$(DOCKER_COMPOSE) build

up: ## Inicia todos os serviÃ§os
	$(DOCKER_COMPOSE) up -d

up-build: ## ConstrÃ³i e inicia todos os serviÃ§os
	$(DOCKER_COMPOSE) up -d --build

down: ## Para todos os serviÃ§os
	$(DOCKER_COMPOSE) down

down-volumes: ## Para todos os serviÃ§os e remove volumes
	$(DOCKER_COMPOSE) down -v

logs: ## Mostra logs do backend
	$(DOCKER_COMPOSE) logs -f $(BACKEND_SERVICE)

logs-all: ## Mostra logs de todos os serviÃ§os
	$(DOCKER_COMPOSE) logs -f

test: ## Executa testes
	$(DOCKER_COMPOSE) exec $(BACKEND_SERVICE) pytest tests/ -v

test-cov: ## Executa testes com cobertura
	$(DOCKER_COMPOSE) exec $(BACKEND_SERVICE) pytest tests/ -v --cov=app --cov-report=html

migrate: ## Executa migraÃ§Ãµes do banco
	$(DOCKER_COMPOSE) exec $(BACKEND_SERVICE) alembic upgrade head

migrate-create: ## Cria nova migraÃ§Ã£o
	$(DOCKER_COMPOSE) exec $(BACKEND_SERVICE) alembic revision --autogenerate -m "$(msg)"

shell: ## Acessa shell do backend
	$(DOCKER_COMPOSE) exec $(BACKEND_SERVICE) /bin/bash

db-shell: ## Acessa shell do PostgreSQL
	$(DOCKER_COMPOSE) exec db psql -U scraper -d scraperdb

init: ## Inicializa projeto (build + up + migrate)
	make build
	make up
	sleep 10
	make migrate

clean: ## Remove containers e volumes
	$(DOCKER_COMPOSE) down -v --rmi all

status: ## Mostra status dos serviÃ§os
	$(DOCKER_COMPOSE) ps

restart: ## Reinicia todos os serviÃ§os
	$(DOCKER_COMPOSE) restart

restart-backend: ## Reinicia apenas o backend
	$(DOCKER_COMPOSE) restart $(BACKEND_SERVICE)

# Comandos para desenvolvimento
dev-setup: ## Setup completo para desenvolvimento
	@echo "ğŸš€ Configurando ambiente de desenvolvimento..."
	cp .env.example .env
	make init
	@echo "âœ… Ambiente pronto! Acesse http://localhost:8000/docs"

load-csv: ## Carrega empresas do CSV
	curl -X POST "http://localhost:8000/api/v1/companies/load-from-csv"

run-pipeline: ## Executa pipeline completo
	curl -X POST "http://localhost:8000/api/v1/scraping/pipeline/full"

check-usage: ## Verifica uso atual da API
	curl "http://localhost:8000/api/v1/usage/today"

export-excel: ## Baixa relatÃ³rio Excel
	curl -o resultados.xlsx "http://localhost:8000/api/v1/scraping/export/excel"

# Comandos de monitoramento
health: ## Verifica saÃºde dos serviÃ§os
	@echo "ğŸ¥ Verificando saÃºde dos serviÃ§os..."
	@curl -s http://localhost:8000/health | python -m json.tool || echo "âŒ Backend indisponÃ­vel"
	@curl -s http://localhost:15672/api/overview -u guest:guest > /dev/null && echo "âœ… RabbitMQ OK" || echo "âŒ RabbitMQ indisponÃ­vel"

stats: ## Mostra estatÃ­sticas das empresas
	curl -s "http://localhost:8000/api/v1/companies/stats/summary" | python -m json.tool